// 外部ユーザーを除外するためにUserPrincipalName条件指定
// Equipmentを除外するためにGivenName条件指定
Set(
    gblUsers,
    Filter(
        Office365ユーザー.SearchUserV2({isSearchTermRequired:false}).value,
        Not(".onmicrosoft.com#EXT#@yappf.onmicrosoft.com" in UserPrincipalName),
        !IsBlank(GivenName)
    )
);

Clear(colUsers);
ForAll(
    gblUsers As User,
    Collect(
        colUsers,
        {
            UPN: User.UserPrincipalName,
            Prop: User,
            Photo: IfError(Office365ユーザー.UserPhotoV2(User.UserPrincipalName), Blank()),
            Manager: IfError(Office365ユーザー.ManagerV2(User.UserPrincipalName), Blank()),
            Direct: Office365ユーザー.DirectReportsV2(User.UserPrincipalName).value
        }
    )
);

Set(
    gblTopLevelUser,
    If(
        CountRows(Filter(colUsers, IsBlank(Manager))) = 1,
        First(Filter(colUsers, IsBlank(Manager))),
        Blank()
    )
)